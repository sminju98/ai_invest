# 금융 에이전트 MVP 기획서 (PRD)

## 1. 배경 / 문제 정의
- TradingView 차트/스크리너를 보면서, 오른쪽에서 LLM이 실시간으로 해설·질의응답을 제공하는 인터페이스를 만든다.
- TradingView “위젯”은 보통 iframe/캔버스 기반이라, LLM이 위젯 내부의 테이블/차트 값을 직접 읽기 어렵다.
- 따라서 “차트를 읽는 것처럼” 동작시키기 위해, **별도 데이터 소스(Yahoo Finance)에서 정형 데이터를 가져와 LLM에 전달**한다.

## 2. 목표(Goals)
- **왼쪽**: TradingView 위젯 기반 화면(차트 / 스크리너+캘린더)을 제공하고, 상단 심볼/간격에 따라 차트가 자동 동기화된다.
- **오른쪽**: 단일 채팅 UI에서
  - 일반 질문: “차트 해설” (스트리밍 타이핑 효과)
  - 뉴스/이슈/일정 질문: **Perplexity로 검색(요약+출처)** 후, 그 결과를 바탕으로 **GPT가 “영향”을 해설(스트리밍)** 자동 수행
- **데이터 공급**
  - 차트 해설용 OHLCV: Yahoo Finance에서 30초 폴링 자동 갱신(기간은 최대한 길게 시도 후 실패 시 축소)
  - 스크리너 분석용 행 데이터: Yahoo Finance predefined screener로 30초 폴링(스크리너 탭일 때)

## 3. 비목표(Non-goals)
- TradingView 위젯 내부 데이터를 직접 파싱/추출(보안/구조상 불가에 가까움)
- 초단위 진짜 실시간(틱 단위) 데이터 보장
- 금융 조언/매매 추천(교육/정보 목적)
- Yahoo 비공식 엔드포인트를 운영/상용 SLA로 제공

## 4. 사용자(Primary Users)
- 차트/스크리너를 보며 빠르게 상황 요약과 체크리스트가 필요한 개인 트레이더/연구자
- 뉴스/촉매/리스크를 출처와 함께 빠르게 파악하고 싶은 사용자

## 5. 핵심 사용자 시나리오
### 5.1 차트 해설
1) 상단에서 심볼/간격 변경  
2) 왼쪽 “차트” 자동 반영  
3) 서버가 Yahoo OHLCV를 주기적으로 갱신  
4) 사용자가 채팅에 질문(예: “현재 구도/시나리오/확인 신호”) 입력  
5) 오른쪽에서 스트리밍으로 답변 출력

### 5.2 스크리너 + 캘린더
1) 왼쪽에서 “스크리너” 선택  
2) 좌측: TradingView 스크리너(미국, 시총 상위)  
3) 우측: TradingView 경제 캘린더(US, 중요도 필터)  
4) 백그라운드에서 Yahoo screener rows 자동 갱신  
5) 사용자가 “스크리너 상위 종목 특징” 질문 → LLM이 Yahoo rows를 기반으로 분석

### 5.3 뉴스/이슈 질문(Perplexity)
1) 사용자가 채팅에 “뉴스/기사/이슈/왜 올랐/촉매/일정/실적/경제지표” 류 질문 입력  
2) 프론트가 자동으로 Perplexity `/api/research`로 라우팅해 **요약+citations(출처 링크)** 확보  
3) 이어서 GPT 해설(`/api/explain_stream`)을 호출해 “시장/가격 관점 영향(촉매/리스크/시나리오/확인 신호)”을 **스트리밍**으로 출력  
4) 화면에는 **출처가 먼저** 표시되고, 그 아래로 영향 해설이 이어짐

### 5.4 공통: 검증자(Verifier) 파이프라인
모든 최종 답변은 아래 3단계를 거친 뒤에만 사용자에게 출력된다.

- **자료 수집(Grounding/Search)**: Perplexity
  - 공개 웹에서 “어떤 관점이 언급되는지”만 수집(내부 참고용)
  - 숫자/사실판정/결론/조언 금지
- **설명(Explanation)**: GPT
  - 사용자가 이해하기 쉬운 구조화된 설명 생성
  - 숫자/투자 판단/예측/‘분석’ 용어 금지
- **검증(Verification/Guardrail)**: 멀티 모델
  - GPT Verifier: 역할/표현 위반 검사(PASS/WARN/FAIL)
  - Gemini Verifier: 숫자/위험 표현/형식 위반 검사(JSON)
  - FAIL이면 설명 단계를 재시도

## 6. 화면/정보 구조(IA)
- 상단 바: 심볼 입력, 간격 선택, 왼쪽 화면 새로고침
- 왼쪽 패널: GNB(차트/스크리너)
  - 차트: TradingView Advanced Chart
  - 스크리너: TradingView Screener + Economic Calendar(2열)
    - 캘린더는 **접기/펼치기** 가능(스크리너 가림 방지)
- 오른쪽 패널: 채팅(메시지 로그 + 입력/전송)
  - 상태: Yahoo 상태 / 마지막 갱신 시간

## 7. 데이터 전략
### 7.1 Yahoo Finance(정형 데이터)
- OHLCV: `/api/yahoo/ohlcv` → `{t,o,h,l,c,v}[]` 최대 200봉
- Screener: `/api/yahoo/screener` → rows(가격/등락/시총/거래량 등)  
  - TradingView 스크리너 위젯은 “표 데이터” 추출이 어려워, **LLM 분석용 수치는 Yahoo rows로 대체**한다.
- Consensus(컨센서스): `/api/yahoo/consensus` → 애널리스트 추천/목표가/실적 추정  
  - Analyst Recommendation (Buy/Hold/Sell 분포, recommendation key/mean)  
  - Target Price (Low/Avg/High)  
  - Earnings Estimate (low/avg/high, yearAgoEps 등)  
  - LLM 해설 시 참고 근거로 포함(“컨센서스는 지연/오류 가능” 고지)
- 레이트리밋/안정성:
  - 30초 폴링(권장)
  - 서버 15초 캐시(동일 파라미터 연타 완화)
  - User-Agent 포함
  - 비공식이므로 변경/차단 가능성 상존

### 7.2 Perplexity(웹 리서치)
- 뉴스/이슈/일정 질문에 대한 요약 + citations(출처 링크)
- 해당 리서치 결과는 **GPT 영향 해설의 근거 컨텍스트**로도 사용
- 정형 데이터 피드로 쓰지 않고 “리서치 보조” 용도로만 사용

### 7.3 OpenAI(해설)
- 기본 모델: `gpt-5.2`
- Chat Completions 기반
- 빈 응답 등 예외 시 Perplexity로 폴백(일부 케이스)

## 8. 정책/고지(중요)
- 투자 조언이 아닌 교육/정보 목적
- Yahoo 비공식 데이터의 정확성/지연/차단 가능성 고지
- API 키는 채팅/깃헙에 노출 금지, `.env`는 커밋 금지

## 9. 성공 지표(Success Metrics)
- 사용자가 “차트/스크리너/뉴스” 질문을 했을 때 **적절한 라우팅**이 되는 비율
- 해설 생성 대기 시간 동안 스트리밍으로 **체감 대기 감소**
- Yahoo 폴링 실패 시 **range 축소로 자동 복구**되는 비율

## 10. 향후 로드맵(후속)
- (정형 데이터) Screener를 더 다양화(scrId 선택, 섹터/필터 UI)
- (캘린더) 이벤트 데이터도 별도 API로 수집해 LLM 입력에 포함(현재는 위젯 표시만)
- (UX) Stop 버튼, 프롬프트 프리셋, 저장/공유
- (운영) 정식 데이터 공급자 전환, 캐시 계층/레이트리밋 강화



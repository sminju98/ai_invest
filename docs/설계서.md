# 금융 에이전트 MVP 설계서 (Technical Design)

## 1. 개요
본 문서는 현재 구현된 “왼쪽 TradingView(차트/스크리너/캘린더) + 오른쪽 채팅(LLM 해설/뉴스)” MVP의 기술 설계를 정리한다.

핵심 원칙:
- TradingView 위젯은 UI 렌더링 전용으로 두고, **LLM 입력에 필요한 수치는 Yahoo Finance에서 정형으로 수집**한다.
- 채팅은 단일 입력창이며, 모든 답변은 **3단계 파이프라인(자료 수집 → 설명 → 검증)**을 통과한 뒤에만 사용자에게 출력한다.

## 2. 아키텍처

### 2.1 구성 요소
- **프론트(정적)**: `public/index.html`, `public/app.js`, `public/styles.css`
- **서버(Node)**: `server.mjs`
  - 정적 파일 서빙
  - Yahoo 데이터 프록시(OHLCV, Screener)
  - LLM 호출(OpenAI/Perplexity)
  - 스트리밍(SSE) 중계
  - 멀티 LLM 오케스트레이션(`/api/chat_stream`)

### 2.2 데이터 플로우(요약)
- 차트(가격 데이터)
  - 브라우저 → `/api/yahoo/ohlcv` (30초 폴링, range 자동 축소)
  - 브라우저 → `/api/yahoo/consensus` (컨센서스, 심볼 변경/요청 시 갱신)
  - 브라우저 → `/api/explain_stream` (OHLCV 포함)
  - 서버 → OpenAI(스트림) → SSE로 브라우저 중계
  - (예외/빈 응답) 서버 → Perplexity 폴백

- 스크리너(상위 시총 등)
  - 브라우저(스크리너 탭일 때) → `/api/yahoo/screener` (30초 폴링)
  - 브라우저 → `/api/explain_stream` (screener rows 포함)

- 뉴스/이슈
  - 브라우저(키워드 감지) → `/api/research` (Perplexity)로 **검색/요약 + citations 확보**
  - 이어서 브라우저 → `/api/explain_stream` (OpenAI 스트리밍) 호출
    - 요청 payload에 `researchAnswer`, `researchCitations`를 포함해 “영향 해설”을 생성
  - 화면에는 citations를 먼저 표시하고, 이후 영향 해설을 스트리밍으로 출력

- 신규(통합): `POST /api/chat_stream`
  - 서버가 내부적으로
    1) Perplexity 자료 수집(JSON)
    2) GPT 설명 생성
    3) Verifier(GPT + Gemini) 검증/재시도
  - 최종 출력만 SSE `final`로 전달(클라이언트가 타이핑처럼 표시)

## 3. 프론트 설계

### 3.1 UI 상태
- 상단 컨트롤
  - `symbol`(예: `NASDAQ:AAPL`)
  - `interval`(TradingView interval: `1,5,15,60,240,D,W,M`)
- 왼쪽 뷰 상태
  - `leftView = "chart" | "screener"`
  - GNB 버튼(`viewChart`, `viewScreener`) + 채팅 키워드 기반 자동 전환
- 데이터 캐시(브라우저 메모리)
  - `latestOhlcvText`: Yahoo OHLCV(JSON 문자열)
  - `latestScreenerText`: Yahoo screener rows(JSON 문자열)
  - `lastScreenerAt`: 마지막 스크리너 갱신 시각

### 3.2 TradingView 위젯 마운트 방식
- `#leftWidgetRoot`에 innerHTML로 컨테이너를 구성하고, 필요한 `script src=...embed-widget-*.js`를 주입한다.
- 차트:
  - `embed-widget-advanced-chart.js`
  - 상단 `symbol/interval` 변경 시 디바운스 리마운트
- 스크리너:
  - `embed-widget-screener.js`
  - 캘린더:
    - `embed-widget-events.js`
  - 스크리너 탭에서는 2열 레이아웃으로 두 위젯을 동시에 마운트
  - 캘린더는 **접기/펼치기 토글**로 숨길 수 있으며, 숨기면 스크리너가 전체 폭을 사용

### 3.3 채팅 라우팅 정책
- 현재 UI는 모든 질문을 **`POST /api/chat_stream`**으로 보낸다.
  - 서버가 내부에서 필요 시 Perplexity 자료 수집을 수행(조건부)
  - 설명/검증은 항상 수행

## 4. 서버 설계(`server.mjs`)

### 4.1 정적 서빙
- `/` 및 `/public/*` 리소스 서빙

### 4.2 Yahoo 프록시
- `GET /api/yahoo/ohlcv`
  - 입력: `symbol`, `interval`, `range`
  - 출력: `{t,o,h,l,c,v}[]` 최대 200봉
  - 캐시: 동일 파라미터 15초 캐시

- `GET /api/yahoo/screener`
  - 입력: `scrId`(현재 허용: `largest_market_cap|most_actives|day_gainers|day_losers`), `count`(<=50)
  - Yahoo endpoint: `https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved`
  - 출력: `rows[]` (symbol/name/exchange/price/changePct/marketCap/volume/currency)
  - 캐시: 동일 파라미터 15초 캐시

- `GET /api/yahoo/consensus`
  - 입력: `symbol`(예: `AAPL` 또는 `NASDAQ:AAPL` → 서버에서 티커로 정규화)
  - Yahoo endpoint: `https://query2.finance.yahoo.com/v10/finance/quoteSummary/{symbol}?modules=price,financialData,recommendationTrend,earningsTrend`
  - 참고: Yahoo quoteSummary는 종종 **crumb/cookie**가 필요하며, Node fetch(undici)의 헤더 제한 문제로 서버는 **https(maxHeaderSize) + getcrumb** 방식으로 우회한다(비공식/취약).
  - 출력(요약):
    - `recommendation`: Buy/Hold/Sell 분포(최근 기간 1개)
    - `targetPrice`: low/avg/high + analystCount + recommendationKey/Mean
    - `earningsEstimate`: low/avg/high(+yearAgoEps)
  - 캐시: 15초

### 4.3 LLM
- `POST /api/chat_stream`
  - SSE 스트리밍(주로 status/final)
  - 내부 파이프라인:
    - Grounding(Perplexity JSON) → Explanation(GPT) → Verification(GPT Verifier + Gemini Verifier)
  - 검증 실패 시 Explanation 재시도(최대 N회)
  - 로그 저장 없음(요청/응답 영구 저장 금지)
- `POST /api/explain`
  - 단발 응답(내부적으로 OpenAI 또는 Perplexity 폴백)
- `POST /api/explain_stream`
  - SSE 스트리밍
  - 이벤트:
    - `meta`: 모델/심볼/interval/활성화 상태
    - `delta`: 토큰/문장 조각
    - `final`: 최종 답변(+citations 가능)
    - `error`
    - `done`

- `POST /api/research`
  - Perplexity 리서치(뉴스/이슈)
  - `citations` 포함 반환

### 4.4 프롬프트 입력 구조(핵심)
- `symbol`, `interval`, `view(chart|screener)`, `ohlcv(선택)`, `screener(선택)`, `question`
- 추가 컨텍스트:
  - `consensus` (Yahoo consensus JSON 문자열, 최대 12KB)
- 뉴스/일정 체인에서 추가되는 컨텍스트:
  - `researchAnswer`(Perplexity 요약 텍스트)
  - `researchCitations`(출처 링크 배열, 최대 10개)
- 위젯 자체가 아니라 Yahoo에서 가져온 정형 데이터가 LLM 입력의 “근거”가 된다.

## 5. 환경변수
- OpenAI
  - `OPENAI_API_KEY`
  - `OPENAI_MODEL` (기본 `gpt-5.2`, `5.2` 입력도 허용)
  - `OPENAI_BASE_URL`
- Perplexity
  - `PERPLEXITY_API_KEY`
  - `PERPLEXITY_MODEL` (기본 `sonar`)
  - `PERPLEXITY_BASE_URL`
- Server
  - `PORT`

## 6. 레이트리밋/안정성/보안
- Yahoo는 비공식:
  - User-Agent 포함
  - 서버 15초 캐시
  - 클라이언트 30초 폴링(권장)
  - 실패 시 range 축소 전략(OHLCV)
- 키 관리:
  - `.env` 로컬 로드 지원, `.gitignore`로 커밋 방지
  - 키를 채팅/로그에 출력하지 않음
- 장애 대응:
  - OpenAI 오류/빈 응답 시 Perplexity 폴백(일부 경로)
  - 에러는 채팅 시스템 메시지로 노출

## 7. 알려진 한계
- TradingView 스크리너/캘린더 위젯의 “표 데이터”를 직접 파싱하지 않음(구조상 어려움)
- Yahoo/Perplexity는 정책 변경/차단/정확도 이슈 가능
- 캘린더 이벤트 데이터는 현재 “표시”만, LLM에 정형 이벤트 데이터로는 전달하지 않음(후속 과제)

## 8. 테스트 체크리스트(수동)
- 상단 심볼/간격 변경 시:
  - 차트 리마운트 정상
  - Yahoo OHLCV 갱신 정상
- 스크리너 탭:
  - 스크리너+캘린더 동시 표시
  - `/api/yahoo/screener` 주기 갱신
  - 스크리너 관련 질문 시 LLM 입력에 rows 포함(응답에서 상위 종목 언급)
- 뉴스 질문:
  - Perplexity로 라우팅
  - citations 출력
- 스트리밍:
  - 타이핑처럼 delta가 누적 표시



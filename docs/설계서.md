# 금융 에이전트 MVP 설계서 (Technical Design)

## 1. 개요
본 문서는 현재 구현된 "왼쪽 TradingView(매크로/스크리너/차트/기업분석/AI 종합 분석) + 오른쪽 채팅(LLM 해설/뉴스/포트폴리오/가상 주문)" MVP의 기술 설계를 정리한다.

### 1.1 버전 구분
- **[v1]**: 현재 코드와 1:1 대응되는 기존 기능 (차트 + AI 해설 도구)
- **[v2 추가]**: Judge Engine 도입으로 새로 추가되는 부분 (투자 판단 생성 엔진)
- **[v2 수정]**: 기존 개념을 확장/정의 변경한 부분

### 1.2 핵심 원칙
- TradingView 위젯은 UI 렌더링 전용으로 두고, **LLM 입력에 필요한 수치는 Yahoo Finance, SEC EDGAR 등 외부 정형 데이터 소스에서 수집**한다.
- 채팅은 단일 입력창이며, 모든 답변은 **3단계 파이프라인(자료 수집 → 설명 → 검증)**을 통과한 뒤에만 사용자에게 출력한다.
- **Judge Engine**은 단순 요약이 아닌 **Decision Stack 기반 투자 판단 생성 엔진**이다.
- 각 분석 카드(매크로, 스크리너, 차트, 기업분석, 최근이슈, 관련주, 공시)는 **독립적으로 분석**되며, 그 결과를 종합하여 최종 판단을 생성한다.
- Firebase를 통한 사용자 인증 및 데이터 영구 저장 지원

## 2. 아키텍처

### 2.1 구성 요소
- **프론트(정적)**: `public/index.html`, `public/app.js`, `public/styles.css`
  - Firebase SDK (Auth, Firestore, Analytics)
  - TradingView 위젯 통합
  - 채팅 UI 및 상태 관리
- **서버(Node)**: `server.mjs`
  - 정적 파일 서빙
  - Yahoo 데이터 프록시 (OHLCV, Screener, Consensus, Quotes, News, Indices, Symbol Search)
  - **SEC EDGAR API 프록시** (`/api/sec/filings`) - [v2 추가]
  - LLM 호출 (OpenAI/Perplexity/Gemini)
  - 스트리밍(SSE) 중계
  - 멀티 LLM 오케스트레이션 (`/api/chat_stream`, `/api/judge_stream`)
  - **Judge Engine** (`/api/judge_stream`) - [v2 추가]
    - Decision Stack 기반 판단 생성
    - 독립 분석 카드 생성 (매크로, 스크리너, 차트, 기업분석, 최근이슈, 관련주, 공시)
    - 종합 판단 JSON 생성
  - 포트폴리오 관리 (`/api/portfolio_extract`, `/api/portfolio_analysis_stream`)
  - 가상 주문 시뮬레이션 (`/api/order_simulate`)
  - 시장 인사이트 (`/api/market_insight`)
  - 티커 관리 (`/api/ticker_enrich`, `/api/ticker_enrich_batch`)
- **Firebase Functions**: `functions/server.mjs` (배포용)
  - 루트 `server.mjs`와 동일한 로직
  - Firebase Hosting과 통합
- **스크립트**: `scripts/import_us_stock_symbols.mjs`
  - 티커 마스터 벌크 임포트

### 2.2 데이터 플로우(요약)
- **차트(가격 데이터)**
  - 브라우저 → `/api/yahoo/ohlcv` (30초 폴링, range 자동 축소)
  - 브라우저 → `/api/yahoo/consensus` (컨센서스, 심볼 변경/요청 시 갱신)
  - 브라우저 → `/api/chat_stream` 또는 `/api/explain_stream` (OHLCV 포함)
  - 서버 → OpenAI(스트림) → SSE로 브라우저 중계
  - (예외/빈 응답) 서버 → Perplexity 폴백

- **스크리너(상위 시총 등)**
  - 브라우저(스크리너 탭일 때) → `/api/yahoo/screener` (30초 폴링)
  - 브라우저 → `/api/chat_stream` (screener rows 포함)

- **매크로(지수 데이터)**
  - 브라우저(매크로 탭일 때) → `/api/yahoo/indices` (주기적 갱신)
  - 브라우저 → `/api/market_insight` (시장 인사이트 요청 시)

- **뉴스/이슈**
  - 브라우저 → `/api/chat_stream` (서버가 내부적으로 Perplexity 자료 수집 수행)
  - 또는 브라우저 → `/api/research` (Perplexity)로 **검색/요약 + citations 확보**
  - 이어서 브라우저 → `/api/explain_stream` (OpenAI 스트리밍) 호출
    - 요청 payload에 `researchAnswer`, `researchCitations`를 포함해 "영향 해설"을 생성
  - 화면에는 citations를 먼저 표시하고, 이후 영향 해설을 스트리밍으로 출력

- **통합 채팅**: `POST /api/chat_stream`
  - 서버가 내부적으로
    1) Perplexity 자료 수집(JSON) - 조건부
    2) GPT 설명 생성
    3) Verifier(GPT + Gemini) 검증/재시도
  - 최종 출력만 SSE `final`로 전달(클라이언트가 타이핑처럼 표시)
  - Firestore에 채팅 세션 및 메시지 저장(로그인 시)

- **종합 판단 (Judge Engine)**: `POST /api/judge_stream` - [v2 확장]
  - **입력**: 
    - `symbol`: 종목 심볼 (예: "NASDAQ:AAPL")
    - `question`: 선택적 질문
    - `macroIndices`: 매크로 지수 데이터 (AI 종합 분석 뷰일 때)
    - `macroNews`: 매크로 뉴스 데이터 (AI 종합 분석 뷰일 때)
    - `screener`: 스크리너 데이터 (AI 종합 분석 뷰일 때)
  - **처리 단계**:
    1. **데이터 수집/정규화 (RAG Bundle 생성)**
       - Yahoo Finance: 재무제표, 뉴스, OHLCV, 관련주
       - SEC EDGAR: 공시 데이터 (비동기, 실패해도 계속 진행) - [v2 추가]
       - 매크로/스크리너: 클라이언트에서 전송한 데이터
       - RAG 번들 생성 및 SSE 이벤트 전송 (`rag`, `rag_bundle`)
    2. **신호 추출** (`gptSignalExtraction`)
       - 각 카드별 신호 추출: financial_signal, event_signal, market_signal, peer_signal, macro_signal, screener_signal
       - SSE 이벤트: `signal` (모든 신호 포함)
    3. **스토리 생성** (`gptStoryLinking`)
       - 신호 간 인과관계 연결
       - SSE 이벤트: `story`
    4. **시장 검증** (`gptMarketAgreement`)
       - 스토리와 시장 신호의 일치 여부 확인
       - SSE 이벤트: `market_check`
    5. **SEC 공시 분석 카드 생성** (`analyzeSecFilingCard`) - [v2 추가]
       - 여러 공시를 하나의 카드로 통합 분석
       - JSON 구조로 분석 결과 생성
       - SSE 이벤트: `sec_filing_card` (독립적으로 전송)
    6. **비교군 보정** (`gptPeerAdjustment`)
       - 산업/관련주 비교 보정
       - SSE 이벤트: `peer_adjust`
    7. **종합 판단 생성** (`gptFinalJudgement`)
       - 모든 독립 분석 카드 결과를 종합하여 최종 판단 생성
       - Decision Stack 순서 준수
       - 검증 단계: Policy Verifier (GPT) + Gemini Verifier (최대 3회 재시도)
       - SSE 이벤트: `final`
  - **독립 분석 카드 구조**:
    1. **매크로 카드** (시장 컨디션)
       - 데이터: Yahoo indices, macro news
       - 신호: `macro_signal`
       - Decision Stack: Macro
    2. **스크리너 카드** (시장 트렌드)
       - 데이터: Yahoo screener rows
       - 신호: `screener_signal`
       - Decision Stack: Relative Choice에 포함
    3. **차트 카드** (가격 위치)
       - 데이터: Yahoo OHLCV, 시장 행동 분석
       - 신호: `market_signal`
       - 시장 검증: `market_check`
       - Decision Stack: Timing
    4. **기업분석 카드** (기업 체력)
       - 데이터: Yahoo financials (재무제표, 밸류에이션)
       - 신호: `financial_signal`
       - Decision Stack: Quality
    5. **최근이슈 카드** (뉴스/이벤트)
       - 데이터: Yahoo news, Perplexity research
       - 신호: `event_signal`
       - Decision Stack: Catalyst & Risk
    6. **관련주 카드** (대안 비교)
       - 데이터: Yahoo peers, industry comparison
       - 신호: `peer_signal`
       - 비교군 보정: `peer_adjust`
       - Decision Stack: Relative Choice
    7. **공시 카드** (SEC 공시 종합 분석) - [v2 추가]
       - 데이터: SEC EDGAR filings (10-K, 10-Q, 8-K 등, 최대 10개)
       - 분석: 여러 공시를 하나의 카드로 통합 분석
       - 출력: JSON 구조 (sentiment, oneLineSummary, meaning, risk, finalJudgement)
       - Decision Stack: Regulatory
  - **Decision Stack 순서로 종합 판단 수행** (반드시 이 순서):
    1. 시장 컨디션 (Macro) - 매크로 카드 결과 활용
    2. 기업 체력 (Quality) - 기업분석 카드 결과 활용
    3. 가격 위치 (Timing) - 차트 카드 결과 활용
    4. 뉴스/이벤트 (Catalyst & Risk) - 최근이슈 카드 결과 활용
    5. 대안 비교 (Relative Choice) - 관련주 카드, 스크리너 카드 결과 활용
    6. SEC 공시 (Regulatory) - 공시 카드 결과 활용 - [v2 추가]
  - **Judge 출력 JSON 스키마 준수**:
    - `final_judgment`: {verdict, confidence}
    - `one_line_summary`: string
    - `decision_stack_reasoning`: {macro, quality, timing, catalyst_risk, relative_choice}
    - `action_guidance`: {recommended_action, conditions}
    - `downside_scenarios`: string[]
    - `raw_data_reference`: {signals_used, data_timestamp, data_sources}
  - **출력**: 
    - 마크다운 형식의 해설 (사용자 표시용)
    - 원문 수치 데이터 (signals, marketCheck, peerAdjust, secFilingCard, rag 메타데이터)
  - Firestore에 저장 (`users/{uid}/judge_runs/{run_id}`)
  - SSE 이벤트: `status`, `rag`, `rag_bundle`, `signal`, `story`, `market_check`, `sec_filing_card`, `peer_adjust`, `final`, `error`, `done`

- **포트폴리오**
  - 브라우저 → `/api/portfolio_extract` (이미지 업로드)
  - 서버 → OpenAI Vision API로 종목/수량/매수가 추출
  - Firestore에 저장 (`users/{uid}/portfolios/current`)
  - 브라우저 → `/api/portfolio_analysis_stream` (포트폴리오 분석)
  - 서버 → Yahoo Quotes 조회 + GPT 분석(스트리밍)

- **가상 주문**
  - 브라우저 → `/api/order_simulate` (주문 정보)
  - 서버 → Yahoo Quotes로 현재가 조회
  - 가상 주문 실행 및 결과 반환(메모리 기반, 세션 종료 시 초기화)

## 3. 프론트 설계

### 3.1 UI 상태
- **상단 컨트롤**
  - `symbol`(예: `NASDAQ:AAPL`) - 자동완성 지원(Firestore 티커 마스터)
  - `interval`(TradingView interval: `1,5,15,60,240,D,W,M`)
  - 새로고침 버튼
- **왼쪽 뷰 상태**
  - `leftView = "macro" | "screener" | "chart" | "company" | "aiAnalysis"`
  - GNB 버튼(`viewMacro`, `viewScreener`, `viewChart`, `viewCompany`, `viewAiAnalysis`)
  - 채팅 키워드 기반 자동 전환 지원
- **데이터 캐시(브라우저 메모리)**
  - `latestOhlcvText`: Yahoo OHLCV(JSON 문자열)
  - `latestScreenerText`: Yahoo screener rows(JSON 문자열)
  - `lastScreenerAt`: 마지막 스크리너 갱신 시각
  - `latestConsensus`: Yahoo consensus 데이터
  - `latestIndices`: Yahoo indices 데이터
- **Firebase 상태**
  - `authUser`: 현재 로그인한 사용자 (null 또는 Firebase User 객체)
  - `currentSessionId`: 현재 채팅 세션 ID
  - `portfolioData`: 현재 포트폴리오 데이터
- **주문 모드 상태**
  - `orderMode`: 가상 주문 모드 활성화 여부
  - `orderData`: 입력 중인 주문 정보

### 3.2 TradingView 위젯 마운트 방식
- `#leftWidgetRoot`에 innerHTML로 컨테이너를 구성하고, 필요한 `script src=...embed-widget-*.js`를 주입한다.
- **매크로 뷰**:
  - TradingView 위젯 또는 Yahoo indices 데이터 표시
- **차트**:
  - `embed-widget-advanced-chart.js`
  - 상단 `symbol/interval` 변경 시 디바운스 리마운트
- **스크리너**:
  - `embed-widget-screener.js`
  - 캘린더:
    - `embed-widget-events.js`
  - 스크리너 탭에서는 2열 레이아웃으로 두 위젯을 동시에 마운트
  - 캘린더는 **접기/펼치기 토글**로 숨길 수 있으며, 숨기면 스크리너가 전체 폭을 사용
- **기업분석**:
  - Yahoo consensus 및 재무 정보 표시
- **AI 종합 분석** - [v2 확장]:
  - **독립 분석 카드 UI**:
    - 각 카드(매크로, 스크리너, 차트, 기업분석, 최근이슈, 관련주, 공시)를 독립적으로 표시
    - 카드별 상태 표시: "대기 중...", "분석 중...", "완료"
    - 카드별 요약(summary) 및 상세 내용(content) 표시
    - 공시 카드는 sentiment 배지(긍정/중립/주의) 표시
  - **종합 판단 결과 표시**:
    - Decision Stack 기반 판단 결과
    - Judge 출력 JSON 스키마 기반 구조화된 표시
    - 원문 수치 데이터 접기/펼치기 UI
    - 최근 결과 복원 기능 (5분 이내)
  - **데이터 수집**:
    - AI 종합 분석 시작 시 매크로/스크리너 데이터 자동 수집
    - SEC 공시 데이터는 서버에서 비동기 수집

### 3.3 채팅 라우팅 정책
- **일반 질문**: `POST /api/chat_stream`
  - 서버가 내부에서 필요 시 Perplexity 자료 수집을 수행(조건부)
  - 설명/검증은 항상 수행
- **종합 판단**: `POST /api/judge_stream`
  - 현재 컨텍스트를 종합해 RAG 번들 생성 후 종합 판단
- **포트폴리오 분석**: `POST /api/portfolio_analysis_stream`
  - 포트폴리오 데이터를 기반으로 분석 제공
- **시장 인사이트**: `POST /api/market_insight`
  - 주요 지수 및 뉴스 기반 시장 요약

### 3.4 Firebase 통합
- **인증**: `public/login.html`, `public/login.js`
  - 이메일/비밀번호 로그인
  - Google 로그인
- **Firestore 데이터 저장**:
  - 채팅 세션 자동 저장(로그인 시)
  - 세션 모드: `day` | `day_symbol` | `symbol` | `topic`
  - 포트폴리오 저장
  - 종합 판단 결과 저장
- **마이페이지**: `public/mypage.html`, `public/mypage.js`
  - 포트폴리오 관리
  - 채팅 세션 모드 설정
  - 티커 마스터 관리

## 4. 서버 설계(`server.mjs`)

### 4.1 정적 서빙
- `/` 및 `/public/*` 리소스 서빙

### 4.2 Yahoo 프록시
- `GET /api/yahoo/ohlcv`
  - 입력: `symbol`, `interval`, `range`
  - 출력: `{t,o,h,l,c,v}[]` 최대 200봉
  - 캐시: 동일 파라미터 15초 캐시
  - range 자동 축소 전략: 최대 기간부터 시도, 실패 시 단계적으로 축소

- `GET /api/yahoo/screener`
  - 입력: `scrId`(현재 허용: `largest_market_cap|most_actives|day_gainers|day_losers`), `count`(<=50)
  - Yahoo endpoint: `https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved`
  - 출력: `rows[]` (symbol/name/exchange/price/changePct/marketCap/volume/currency)
  - 캐시: 동일 파라미터 15초 캐시

- `GET /api/yahoo/consensus`
  - 입력: `symbol`(예: `AAPL` 또는 `NASDAQ:AAPL` → 서버에서 티커로 정규화)
  - Yahoo endpoint: `https://query2.finance.yahoo.com/v10/finance/quoteSummary/{symbol}?modules=price,financialData,recommendationTrend,earningsTrend`
  - 참고: Yahoo quoteSummary는 종종 **crumb/cookie**가 필요하며, Node fetch(undici)의 헤더 제한 문제로 서버는 **https(maxHeaderSize) + getcrumb** 방식으로 우회한다(비공식/취약).
  - 출력(요약):
    - `recommendation`: Buy/Hold/Sell 분포(최근 기간 1개)
    - `targetPrice`: low/avg/high + analystCount + recommendationKey/Mean
    - `earningsEstimate`: low/avg/high(+yearAgoEps)
  - 캐시: 15초

- `GET /api/yahoo/quotes`
  - 입력: `symbols` (쉼표로 구분된 심볼 목록)
  - 출력: `quotes[]` (시세 정보)
  - 캐시: 10초

- `GET /api/yahoo/news`
  - 입력: `symbol`, `count`
  - 출력: `news[]` (뉴스 헤드라인)
  - 캐시: 60초

- `GET /api/yahoo/indices`
  - 입력: 없음
  - 출력: `indices[]` (주요 시장 지수 정보)
  - 캐시: 30초

- `GET /api/yahoo/symbol_search`
  - 입력: `q` (검색어)
  - 출력: `symbols[]` (검색 결과)
  - Firestore 티커 마스터와 통합 가능

- `GET /api/sec/filings` - [v2 추가]
  - 입력: `symbol` (티커 심볼, 예: `AAPL`)
  - 출력: `{ok, symbol, companyName, tickers, filings[], asOf}`
  - SEC EDGAR API를 통한 공시 데이터 조회
  - 최근 공시(10-K, 10-Q, 8-K, DEF 14A 등) 필터링
  - User-Agent 헤더 필수 (SEC API 정책)

### 4.3 LLM
- `POST /api/chat_stream`
  - SSE 스트리밍(주로 status/final)
  - 내부 파이프라인:
    - Grounding(Perplexity JSON) → Explanation(GPT) → Verification(GPT Verifier + Gemini Verifier)
  - 검증 실패 시 Explanation 재시도(최대 N회)
  - Firestore에 채팅 세션 및 메시지 저장(로그인 시)
  - 이벤트: `status`, `final`, `error`, `done`

- `POST /api/judge_stream` - [v2 확장]
  - 종합 판단 생성(스트리밍)
  - **독립 분석 카드 생성 단계**:
    - 각 카드(매크로, 스크리너, 차트, 기업분석, 최근이슈, 관련주, 공시)를 독립적으로 분석
    - 공시 카드는 여러 공시를 하나의 카드로 통합 분석
  - **Decision Stack 구조 준수** (반드시 이 순서):
    1. 시장 컨디션 (Macro)
    2. 기업 체력 (Quality)
    3. 가격 위치 (Timing)
    4. 뉴스/이벤트 (Catalyst & Risk)
    5. 대안 비교 (Relative Choice)
    6. SEC 공시 (Regulatory) - [v2 추가]
  - 현재 컨텍스트를 종합해 RAG 번들 생성
  - **Judge 출력 JSON 스키마 준수**:
    ```json
    {
      "final_judgment": {
        "verdict": "WAIT | BUY | ACCUMULATE | REDUCE | AVOID",
        "confidence": "LOW | MEDIUM | HIGH"
      },
      "one_line_summary": "string",
      "decision_stack_reasoning": {
        "macro": "string",
        "quality": "string",
        "timing": "string",
        "catalyst_risk": "string",
        "relative_choice": "string"
      },
      "action_guidance": {
        "recommended_action": "string",
        "conditions": ["string"]
      },
      "downside_scenarios": ["string"],
      "raw_data_reference": {
        "signals_used": ["string"],
        "data_timestamp": "ISO-8601",
        "data_sources": ["Yahoo Finance", "SEC EDGAR", "Perplexity"]
      }
    }
    ```
  - **출력 형식**: 해설 + 원문 수치 데이터 (신호 JSON, 시장 검증, 비교군 보정, SEC 공시 카드 등)
  - 원문 수치는 접기/펼치기 가능한 섹션으로 제공
  - Firestore에 저장 (`users/{uid}/judge_runs/{run_id}`)
  - 이벤트: `status`, `rag`, `rag_bundle`, `signal`, `story`, `market_check`, `sec_filing_card`, `peer_adjust`, `final`, `error`, `done`

- `POST /api/explain`
  - 단발 응답(내부적으로 OpenAI 또는 Perplexity 폴백)

- `POST /api/explain_stream`
  - SSE 스트리밍
  - 이벤트:
    - `meta`: 모델/심볼/interval/활성화 상태
    - `delta`: 토큰/문장 조각
    - `final`: 최종 답변(+citations 가능)
    - `error`
    - `done`

- `POST /api/research`
  - Perplexity 리서치(뉴스/이슈)
  - `citations` 포함 반환

- `POST /api/market_insight`
  - 시장 인사이트 생성
  - 주요 지수 및 뉴스 헤드라인 기반
  - 5분 캐시(서버리스 warm 상태에서만 유효)
  - Firestore에 저장 가능 (`users/{uid}/insights/{id}`)

- `POST /api/portfolio_extract`
  - 포트폴리오 이미지에서 종목 정보 추출
  - OpenAI Vision API 사용
  - 입력: `images[]` (base64 또는 URL), `hintSymbol` (선택)
  - 출력: `positions[]` (symbol, qty, avgPrice, currency, confidence, notes)

- `POST /api/portfolio_analysis_stream`
  - 포트폴리오 분석(스트리밍)
  - Yahoo Quotes 조회 + GPT 분석
  - 이벤트: `status`, `delta`, `final`, `error`, `done`

- `POST /api/order_simulate`
  - 가상 주문 시뮬레이션
  - 입력: `symbol`, `side` (BUY/SELL), `type` (MARKET/LIMIT), `qty`, `limitPrice` (선택)
  - Yahoo Quotes로 현재가 조회
  - 출력: `order` (id, status, filledPrice, createdAt 등)
  - 메모리 기반 저장(세션 종료 시 초기화)

- `POST /api/ticker_enrich`
  - 단일 티커 한글명/별칭 보강
  - OpenAI GPT 사용

- `POST /api/ticker_enrich_batch`
  - 여러 티커 일괄 보강
  - 진행 상황 추적 지원

### 4.4 프롬프트 입력 구조(핵심)
- **기본 컨텍스트**:
  - `symbol`, `interval`, `view` (macro|screener|chart|company|aiAnalysis)
  - `ohlcv` (선택, Yahoo OHLCV JSON 문자열)
  - `screener` (선택, Yahoo screener rows JSON 문자열)
  - `question`
- **추가 컨텍스트**:
  - `consensus` (Yahoo consensus JSON 문자열, 최대 12KB)
  - `indices` (Yahoo indices JSON 문자열, 매크로 뷰 시)
  - `news` (Yahoo news 헤드라인 배열)
- **뉴스/일정 체인에서 추가되는 컨텍스트**:
  - `researchAnswer` (Perplexity 요약 텍스트)
  - `researchCitations` (출처 링크 배열, 최대 10개)
- **포트폴리오 분석 컨텍스트**:
  - `positions` (포트폴리오 보유 종목 배열)
  - `quotes` (Yahoo Quotes 데이터)
- **종합 판단 컨텍스트 (Decision Stack 기반)** - [v2 확장]:
  - `signals`: 재무 신호, 이벤트 신호, 시장 신호, 비교군 신호, 매크로 신호, 스크리너 신호
  - `marketCheck`: 시장과의 일관성/불일치 검증 데이터
  - `peerAdjust`: 산업/관련주 비교 보정 데이터
  - `secFilingCard`: SEC 공시 종합 분석 카드 (여러 공시를 하나로 통합) - [v2 추가]
    - `sentiment`: "positive" | "neutral" | "caution"
    - `oneLineSummary`: 한 줄 요약
    - `meaning`: 투자자에게 의미
    - `risk`: 주의할 점
    - `finalJudgement`: AI 종합 판단
  - RAG 번들: 현재 컨텍스트를 종합한 구조화된 데이터
- 위젯 자체가 아니라 **Yahoo Finance, SEC EDGAR 등 외부 정형 데이터 소스**에서 가져온 데이터가 LLM 입력의 "근거"가 된다.

### 4.5 출력 형식 구조 (강제) - [v2 확장]

모든 종합 판단 출력은 다음 구조를 **반드시** 준수한다:

#### 4.5.1 마크다운 출력 형식 (사용자 표시용)

1. **AI 종합 판단 (결론 먼저)**: 
   - Verdict: WAIT | BUY | ACCUMULATE | REDUCE | AVOID
   - 확신도: LOW | MEDIUM | HIGH
   - 예: "AI 판단: 지금은 관망이 합리적입니다" 또는 "AI 판단: 매수 고려가 적절합니다"
2. **한 줄 요약**: 
   - 숫자 최소화
   - 비교/맥락 중심
   - '왜 그런지'가 드러나야 함
3. **판단 근거 (최대 5개, Decision Stack 순서)**:
   - 각 항목은 2문장 이내
   - 시장 컨디션 (Macro): 매크로 환경이 기업에 미치는 영향
   - 기업 체력 (Quality): 재무/밸류에이션 관점
   - 가격 위치 (Timing): 차트/기술적 관점
   - 뉴스/이벤트 (Catalyst & Risk): 촉매/리스크 관점
   - 대안 비교 (Relative Choice): 스크리너 트렌드와의 연관성, 관련주/산업 비교
   - SEC 공시 (Regulatory): 최근 공시 문서의 주요 내용 및 시장 영향 - [v2 추가]
4. **지금 할 수 있는 선택지**: 
   - 관망/분할 접근/주의 필요/매수 고려/매도 고려 등
   - 명확한 판단과 선택지 제시
   - 조건부·맥락 기반 투자 판단 허용 (무조건적/단정적 투자 조언 금지)
5. **하방/실패 시나리오**: 가능한 리스크 및 실패 시나리오 제시
6. **원문 수치 데이터 (접을 수 있는 섹션)**:
   - 신호 JSON (signals)
   - 시장 검증 데이터 (marketCheck)
   - 비교군 보정 데이터 (peerAdjust)
   - SEC 공시 분석 카드 (secFilingCard) - [v2 추가]
   - RAG 번들 메타데이터
   - 사용자가 필요 시 펼쳐서 확인 가능하도록 UI 제공

#### 4.5.2 JSON 스키마 (기획서 준수) - [v2 추가]

Judge 출력은 기획서에 정의된 JSON 스키마를 준수해야 한다:

```json
{
  "final_judgment": {
    "verdict": "WAIT | BUY | ACCUMULATE | REDUCE | AVOID",
    "confidence": "LOW | MEDIUM | HIGH"
  },
  "one_line_summary": "string",
  "decision_stack_reasoning": {
    "macro": "string",
    "quality": "string",
    "timing": "string",
    "catalyst_risk": "string",
    "relative_choice": "string"
  },
  "action_guidance": {
    "recommended_action": "string",
    "conditions": ["string"]
  },
  "downside_scenarios": ["string"],
  "raw_data_reference": {
    "signals_used": ["string"],
    "data_timestamp": "ISO-8601",
    "data_sources": ["Yahoo Finance", "SEC EDGAR", "Perplexity"]
  }
}
```

> **중요**: 
> - 해설은 일반 투자자가 이해하기 쉬운 말로 번역하되, **원문 수치 데이터는 반드시 함께 제공**하여 투명성과 검증 가능성을 보장한다.
> - Judge 출력은 기획서의 JSON 스키마를 준수해야 하며, `/api/judge_stream`, Firestore 저장, Front-end UI의 단일 기준이 된다.
> - 각 독립 분석 카드의 결과는 실시간으로 SSE 이벤트로 전송되며, 최종 종합 판단에서 모든 카드 결과를 종합한다.

## 5. 환경변수
- **OpenAI**
  - `OPENAI_API_KEY` (필수)
  - `OPENAI_MODEL` (기본 `gpt-5.2`, `5.2` 입력도 허용)
  - `OPENAI_BASE_URL` (기본 `https://api.openai.com/v1`)
  - `OPENAI_VISION_MODEL` (기본 `gpt-4o-mini`, 포트폴리오 이미지 추출용)
  - `OPENAI_PORTFOLIO_MODEL` (기본 `gpt-4.1-mini`, 포트폴리오 분석용)
- **Perplexity**
  - `PERPLEXITY_API_KEY` (선택, 리서치 기능용)
  - `PERPLEXITY_MODEL` (기본 `sonar`)
  - `PERPLEXITY_BASE_URL` (기본 `https://api.perplexity.ai`)
- **Google Gemini**
  - `GEMINI_API_KEY` (선택, 검증자용)
  - `GEMINI_MODEL` (기본 `gemini-3-pro-preview`)
- **SEC EDGAR** - [v2 추가]
  - `SEC_USER_AGENT` (선택, 기본값: "FinanceAgent/1.0 (contact@example.com)")
  - SEC API는 User-Agent 헤더 필수 (정책 준수)
- **Firebase** (선택)
  - `FIREBASE_SERVICE_ACCOUNT_PATH` (티커 임포트 스크립트용)
  - 또는 `FIREBASE_SERVICE_ACCOUNT_JSON` (JSON 문자열)
- **Server**
  - `PORT` (기본 `8787`)

## 6. 레이트리밋/안정성/보안
- Yahoo는 비공식:
  - User-Agent 포함
  - 서버 15초 캐시
  - 클라이언트 30초 폴링(권장)
  - 실패 시 range 축소 전략(OHLCV)
- 키 관리:
  - `.env` 로컬 로드 지원, `.gitignore`로 커밋 방지
  - 키를 채팅/로그에 출력하지 않음
- 장애 대응:
  - OpenAI 오류/빈 응답 시 Perplexity 폴백(일부 경로)
  - 에러는 채팅 시스템 메시지로 노출

## 7. 알려진 한계
- TradingView 스크리너/캘린더 위젯의 "표 데이터"를 직접 파싱하지 않음(구조상 어려움)
- Yahoo/Perplexity는 정책 변경/차단/정확도 이슈 가능
- 캘린더 이벤트 데이터는 현재 "표시"만, LLM에 정형 이벤트 데이터로는 전달하지 않음(후속 과제)
- 가상 주문은 메모리 기반으로 세션 종료 시 초기화됨(영구 저장 미구현)
- 포트폴리오 이미지 추출 정확도는 이미지 품질에 의존
- Firebase 설정이 없으면 로그인/데이터 저장 기능 비활성화(로컬 저장으로 폴백)

## 8. API 엔드포인트 목록

### 8.1 Yahoo Finance 프록시
- `GET /api/yahoo/ohlcv` - OHLCV 데이터
- `GET /api/yahoo/screener` - 스크리너 데이터
- `GET /api/yahoo/consensus` - 컨센서스 데이터
- `GET /api/yahoo/quotes` - 시세 정보
- `GET /api/yahoo/news` - 뉴스 헤드라인
- `GET /api/yahoo/indices` - 지수 정보
- `GET /api/yahoo/symbol_search` - 심볼 검색

### 8.2 LLM 관련
- `POST /api/chat_stream` - 통합 채팅 (스트리밍)
- `POST /api/judge_stream` - 종합 판단 (스트리밍) - [v2 확장: Judge Engine]
- `POST /api/explain` - 해설 (단발)
- `POST /api/explain_stream` - 해설 (스트리밍)
- `POST /api/research` - Perplexity 리서치
- `POST /api/market_insight` - 시장 인사이트

### 8.6 SEC EDGAR - [v2 추가]
- `GET /api/sec/filings` - 공시 데이터 조회

### 8.3 포트폴리오
- `POST /api/portfolio_extract` - 이미지에서 포트폴리오 추출
- `POST /api/portfolio_analysis_stream` - 포트폴리오 분석 (스트리밍)

### 8.4 주문
- `POST /api/order_simulate` - 가상 주문 시뮬레이션

### 8.5 티커 관리
- `POST /api/ticker_enrich` - 단일 티커 보강
- `POST /api/ticker_enrich_batch` - 티커 일괄 보강

## 9. 파일 구조

```
/
├── api/                    # API 핸들러 모듈
│   ├── _util.js           # 공통 유틸리티
│   ├── chat_stream.js      # 통합 채팅 스트리밍
│   ├── market_insight.js   # 시장 인사이트
│   ├── order_simulate.js   # 가상 주문
│   ├── portfolio_extract.js        # 포트폴리오 이미지 추출
│   ├── portfolio_analysis_stream.js # 포트폴리오 분석
│   ├── ticker_enrich.js            # 티커 보강
│   ├── ticker_enrich_batch.js      # 티커 일괄 보강
│   └── yahoo/             # Yahoo Finance 프록시
│       ├── consensus.js
│       ├── indices.js
│       ├── news.js
│       ├── ohlcv.js
│       ├── quotes.js
│       ├── screener.js
│       └── symbol_search.js
├── docs/                   # 문서
│   ├── 기획서.md
│   └── 설계서.md
├── functions/              # Firebase Functions
│   ├── index.js
│   ├── server.mjs
│   └── package.json
├── public/                 # 정적 파일
│   ├── index.html          # 메인 페이지
│   ├── app.js              # 프론트엔드 로직
│   ├── styles.css          # 스타일
│   ├── login.html          # 로그인 페이지
│   ├── login.js
│   ├── mypage.html         # 마이페이지
│   ├── mypage.js
│   ├── portfolio.html     # 포트폴리오 페이지
│   ├── portfolio.js
│   ├── admin_ticker_import.html  # 관리자 티커 임포트
│   ├── admin_ticker_import.js
│   └── firebase-config.js  # Firebase 설정
├── scripts/                # 스크립트
│   └── import_us_stock_symbols.mjs  # 티커 마스터 임포트
├── server.mjs              # 메인 서버
├── package.json
├── firebase.json           # Firebase 설정
└── vercel.json             # Vercel 설정
```

## 10. 테스트 체크리스트(수동)
- **상단 심볼/간격 변경 시**:
  - 차트 리마운트 정상
  - Yahoo OHLCV 갱신 정상
  - 심볼 자동완성 동작 확인
- **스크리너 탭**:
  - 스크리너+캘린더 동시 표시
  - 캘린더 접기/펼치기 동작
  - `/api/yahoo/screener` 주기 갱신
  - 스크리너 관련 질문 시 LLM 입력에 rows 포함(응답에서 상위 종목 언급)
- **매크로 탭**:
  - 지수 데이터 표시
  - 시장 인사이트 생성
- **기업분석 탭**:
  - 컨센서스 데이터 표시
- **AI 종합 분석 탭** - [v2 확장]:
  - **독립 분석 카드 표시**:
    - 매크로 카드: 시장 컨디션 분석 결과
    - 스크리너 카드: 시장 트렌드 분석 결과
    - 차트 카드: 가격 위치 분석 결과 (시장 검증 포함)
    - 기업분석 카드: 기업 체력 분석 결과
    - 최근이슈 카드: 뉴스/이벤트 분석 결과
    - 관련주 카드: 대안 비교 분석 결과 (비교군 보정 포함)
    - 공시 카드: SEC 공시 종합 분석 결과 (sentiment 배지 포함) - [v2 추가]
  - **각 카드의 독립 분석 결과 표시**:
    - 카드별 상태 실시간 업데이트
    - 카드별 요약 및 상세 내용 표시
    - SSE 이벤트로 실시간 업데이트
  - **종합 판단 결과 표시**:
    - Decision Stack 기반 판단 결과
    - Judge 출력 JSON 스키마 준수
    - Verdict 및 Confidence 표시
    - Decision Stack Reasoning 표시
    - Action Guidance 및 Downside Scenarios 표시
  - **원문 수치 데이터 접기/펼치기 UI**:
    - 신호 JSON, 시장 검증, 비교군 보정, SEC 공시 카드, RAG 메타데이터
    - 사용자가 필요 시 펼쳐서 확인 가능
- **뉴스 질문**:
  - Perplexity로 라우팅
  - citations 출력
- **스트리밍**:
  - 타이핑처럼 delta가 누적 표시
- **포트폴리오**:
  - 이미지 업로드 및 추출
  - 포트폴리오 분석 스트리밍
- **가상 주문**:
  - 주문 모드 활성화
  - 주문 실행 및 결과 표시
- **Firebase 통합**:
  - 로그인/회원가입
  - 채팅 세션 자동 저장
  - 포트폴리오 저장
  - Judge 실행 결과 저장 (`judge_runs/{run_id}`)
  - 마이페이지 기능

- **Judge Engine** - [v2 추가]:
  - 독립 분석 카드 생성 확인
  - Decision Stack 순서 준수 확인
  - Judge 출력 JSON 스키마 준수 확인
  - SEC 공시 카드 통합 확인
  - 원문 수치 데이터 표시 확인


